name: Generate Diagrams from LinkML (using existing script)

on:
  push:
    branches: ["main"]
    paths:
      - 'docs/**'
      - 'tools/linkml_to_puml.py'
      - '.github/workflows/generate-diagrams.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-and-render:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml

      - name: Ensure output dir exists
        run: |
          mkdir -p docs/diagrams/generated

      - name: Run linkml_to_puml.py
        run: |
          # adjust input/output paths if your files live elsewhere
          python tools/linkml_to_puml.py docs/flexibility_products.linkml.yaml docs/diagrams/generated/flexibility_products_auto.puml
          echo "Generated PUML:"
          sed -n '1,200p' docs/diagrams/generated/flexibility_products_auto.puml || true

      - name: Install Java + Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends openjdk-17-jre-headless graphviz curl unzip
          sudo rm -rf /var/lib/apt/lists/*

      - name: Download plantuml.jar
        run: |
          mkdir -p /opt/plantuml
          curl -sL -o /opt/plantuml/plantuml.jar https://github.com/plantuml/plantuml/releases/latest/download/plantuml.jar
          java -jar /opt/plantuml/plantuml.jar -version || true

      - name: Render PUML -> SVG and PNG
        run: |
          # render everything under docs/diagrams/generated and docs/diagrams
          find docs/diagrams -type f -name '*.puml' -print0 | while IFS= read -r -d '' f; do
            echo "Rendering: $f"
            java -jar /opt/plantuml/plantuml.jar -tsvg "$f" || true
            java -jar /opt/plantuml/plantuml.jar -tpng "$f" || true
          done

      - name: Show generated images
        run: |
          find docs/diagrams -type f \( -name '*.svg' -o -name '*.png' \) -print || true

      - name: Commit & push generated diagrams (if any)
        env:
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "github-actions[bot]@users.noreply.github.com"
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"
          git add docs/diagrams || true
          if ! git diff --cached --quiet; then
            git commit -m "ci: auto-generate diagrams from LinkML [skip ci]" || true
            git push origin HEAD || true
          else
            echo "No generated changes to commit."
          fi